<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­åº«å­˜å®‰å…¨ç³»çµ± v13.0</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f6; margin: 0; padding: 0; }
        nav { background: var(--primary); color: white; display: flex; justify-content: center; padding: 10px; gap: 5px; position: sticky; top: 0; z-index: 100; }
        nav button { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px; cursor: pointer; border-radius: 5px; }
        nav button.active { background: var(--accent); font-weight: bold; }
        .container { max-width: 1100px; margin: 15px auto; padding: 15px; }
        .page { display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .page.active { display: block; }
        .sync-status { text-align: center; font-size: 11px; padding: 5px; background: #eee; color: #666; }
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        button.btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background: var(--success); }
        .btn-action { background: var(--accent); }
        .btn-del { background: var(--danger); font-size: 0.8rem; }
        .location-badge { background: #e1f5fe; color: #01579b; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 10px; text-align: left; }
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
    </style>
</head>
<body>

<div id="authOverlay">
    <h2>ğŸ”’ ç³»çµ±é–å®š</h2>
    <input type="password" id="sysKeyInput" style="flex:none; width: 180px; margin-bottom: 15px; text-align: center;" placeholder="è¼¸å…¥é‡‘é‘°">
    <button class="btn btn-action" onclick="initSystem()">è§£é–é€²å…¥</button>
</div>

<div class="sync-status" id="syncLabel">ç‹€æ…‹ï¼šç­‰å¾…è§£é–</div>

<nav>
    <button onclick="showPage('p1')" id="btn-p1" class="active">ğŸ†• å»ºæª”</button>
    <button onclick="showPage('p2')" id="btn-p2">ğŸ“‹ ç¸½è¡¨</button>
    <button onclick="showPage('p3')" id="btn-p3">ğŸ›’ å¤–å€Ÿ</button>
    <button onclick="showPage('p4')" id="btn-p4">ğŸ”§ ç›¤é»</button>
    <button onclick="showPage('p5')" id="btn-p5">ğŸ“œ ç´€éŒ„</button>
</nav>

<div class="container">
    <div id="p1" class="page active">
        <h3>æ–°å¢å“é …</h3>
        <div class="input-group">
            <input type="text" id="pName" placeholder="åç¨±">
            <input type="number" id="pQty" placeholder="æ•¸é‡">
            <input type="text" id="pLoc" placeholder="å€‰ä½">
            <button class="btn btn-add" onclick="addProduct()">ç¢ºèªæ–°å¢</button>
        </div>
        <table id="setupTable"><thead><tr><th>åç¨±</th><th>åº«å­˜</th><th>å€‰ä½</th><th>ç®¡ç†</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="p2" class="page">
        <h3>åº«å­˜ç¸½è¡¨ (é»æ“Šæ¬ç§»å¯è®Šæ›´å€‰ä½)</h3>
        <button class="btn btn-action" style="background:#607d8b; margin-bottom:10px;" onclick="exportToCSV()">ğŸ“Š åŒ¯å‡º Excel</button>
        <table id="fullTable"><thead><tr><th>åç¨±</th><th>ç¸½æ•¸/å‰©é¤˜</th><th>ç›®å‰å€‰ä½</th><th>ç®¡ç†</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="p3" class="page">
        <h3>ğŸ›’ å¤–å€Ÿè³¼ç‰©è»Š</h3>
        <div style="background:#f0f7ff; padding:15px; border-radius:10px; margin-bottom:20px; border:2px dashed #3498db;">
            <div class="input-group">
                <select id="cartProductSelect"></select>
                <input type="number" id="cartQty" value="1" min="1" style="width:60px; flex:none;">
                <button class="btn btn-add" onclick="addToCart()">â• åŠ å…¥</button>
            </div>
            <table id="cartTable"><thead><tr><th>å“é …</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
            <div class="input-group" style="margin-top:10px;">
                <input type="text" id="loanUser" placeholder="å€Ÿç”¨äººå§“å">
                <button class="btn btn-action" onclick="checkoutCart()" style="flex:2;">ğŸš€ æ‰¹æ¬¡å€Ÿå‡º</button>
            </div>
        </div>
        <table id="loanTable"><thead><tr><th>å€Ÿç”¨äºº</th><th>ç‰©å“</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="p4" class="page">
        <h3>ç›¤é»ä¿®æ­£</h3>
        <table id="stocktakeTable"><thead><tr><th>åç¨±</th><th>å¸³é¢æ•¸</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="p5" class="page">
        <h3>ç•°å‹•ç´€éŒ„</h3>
        <table id="historyTable"><thead><tr><th>æ™‚é–“</th><th>å“é …</th><th>è®Šå‹•</th><th>åŸå› </th></tr></thead><tbody></tbody></table>
    </div>
</div>

<script>
    // âš ï¸ æª¢æŸ¥é»ï¼šè«‹ç¢ºä¿é€™è£¡å¡«å…¥äº†æ­£ç¢ºçš„éƒ¨ç½²ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbzabXBVljgap-NVRWnv3w73CGRZuIDAR48K2kpCOOjq1tyYu_gQavJe_lBO0u-Px71Yqw/exec"; 
    let sysKey = "1225"; // ä½ è¨­å®šçš„ç³»çµ±é‡‘é‘°
    let products = [], loans = [], history = [], cart = [];

    async function initSystem() {
        const inputKey = document.getElementById('sysKeyInput').value;
        if(inputKey === sysKey) {
            document.getElementById('syncLabel').innerText = "é©—è­‰é€šéï¼Œæ­£åœ¨é€£æ¥è³‡æ–™åº«...";
            // å˜—è©¦åŒæ­¥ï¼Œå¦‚æœ API ç¶²å€æ˜¯ç©ºçš„æˆ–éŒ¯çš„ï¼Œæœƒåœ¨é€™è£¡å ±éŒ¯
            try {
                const isSuccess = await syncFromCloud();
                if(isSuccess) {
                    document.getElementById('authOverlay').style.display = 'none';
                }
            } catch (e) {
                alert("é€£ç·šå¤±æ•—ï¼è«‹æª¢æŸ¥ index.html å…§çš„ API_URL æ˜¯å¦å¡«å¯«æ­£ç¢ºã€‚");
                console.error(e);
            }
        } else {
            alert("é‡‘é‘°éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼");
        }
    }

    async function syncFromCloud() {
        if(API_URL.includes("è«‹åœ¨æ­¤è™•å¡«å…¥")) {
            alert("å°šæœªå¡«å¯« API_URLï¼Œè«‹å…ˆä¿®æ”¹ç¨‹å¼ç¢¼ã€‚");
            return false;
        }
        document.getElementById('syncLabel').innerText = "é›²ç«¯åŒæ­¥ä¸­...";
        try {
            const res = await fetch(`${API_URL}?key=${sysKey}`);
            const data = await res.json();
            if(data.error) {
                alert("é›²ç«¯æ‹’çµ•é€£ç·šï¼š" + data.error);
                return false;
            }
            products = data.products || [];
            loans = data.loans || [];
            history = data.history || [];
            renderAll();
            document.getElementById('syncLabel').innerText = "åŒæ­¥æˆåŠŸ";
            return true;
        } catch (e) {
            document.getElementById('syncLabel').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²è·¯";
            throw e;
        }
    }
    // ... å…¶é¤˜å‡½æ•¸ä¿æŒä¸è®Š ...
</script>

    async function save() {
        document.getElementById('syncLabel').innerText = "å„²å­˜ä¸­...";
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ key: sysKey, data: { products, loans, history } })
            });
            document.getElementById('syncLabel').innerText = "å„²å­˜æˆåŠŸ";
        } catch (e) { document.getElementById('syncLabel').innerText = "å„²å­˜å¤±æ•—"; }
        renderAll();
    }

    // --- é—œéµä¿®å¾©ï¼šç§»å€‰åŠŸèƒ½ ---
    function moveLocation(pid) {
        const p = products.find(item => item.id == pid);
        if(!p) return;
        const oldLoc = p.loc || "æœªè¨­å®š";
        const newLoc = prompt(`è®Šæ›´ã€Œ${

