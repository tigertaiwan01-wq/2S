<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­åº«å­˜å®‰å…¨ç³»çµ± v14.0</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f6; margin: 0; padding: 0; }
        nav { background: var(--primary); color: white; display: flex; justify-content: center; padding: 10px; gap: 5px; position: sticky; top: 0; z-index: 100; }
        nav button { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px; cursor: pointer; border-radius: 5px; }
        nav button.active { background: var(--accent); font-weight: bold; }
        .container { max-width: 1100px; margin: 15px auto; padding: 15px; }
        .page { display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .page.active { display: block; }
        .sync-status { text-align: center; font-size: 11px; padding: 5px; background: #eee; color: #666; }
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        button.btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background: var(--success); }
        .btn-action { background: var(--accent); }
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
    </style>
</head>
<body>

<div id="authOverlay">
    <h2>ğŸ”’ ç³»çµ±é–å®š</h2>
    <p id="msg" style="color:#f39c12; font-size:0.9rem">è«‹è¼¸å…¥ç³»çµ±é‡‘é‘°ä»¥é€²è¡Œé€£ç·š</p>
    <input type="password" id="sysKeyInput" style="flex:none; width: 200px; margin-bottom: 15px; text-align: center;" placeholder="è¼¸å…¥ 1225">
    <button class="btn btn-action" onclick="initSystem()">è§£é–é€²å…¥</button>
</div>

<div class="sync-status" id="syncLabel">ç‹€æ…‹ï¼šç­‰å¾…é©—è­‰</div>

<nav>
    <button onclick="showPage('p1')" id="btn-p1" class="active">ğŸ†• å»ºæª”</button>
    <button onclick="showPage('p2')" id="btn-p2">ğŸ“‹ ç¸½è¡¨</button>
    <button onclick="showPage('p3')" id="btn-p3">ğŸ›’ å¤–å€Ÿ</button>
    <button onclick="showPage('p4')" id="btn-p4">ğŸ”§ ç›¤é»</button>
    <button onclick="showPage('p5')" id="btn-p5">ğŸ“œ ç´€éŒ„</button>
</nav>

<div class="container">
    <div id="p1" class="page active">
        <h3>æ–°å¢å“é …èˆ‡å€‰ä½</h3>
        <div class="input-group">
            <input type="text" id="pName" placeholder="åç¨±">
            <input type="number" id="pQty" placeholder="æ•¸é‡">
            <input type="text" id="pLoc" placeholder="å€‰ä½">
            <button class="btn btn-add" onclick="addProduct()">ç¢ºèªæ–°å¢</button>
        </div>
        <table id="setupTable"><thead><tr><th>åç¨±</th><th>åº«å­˜</th><th>å€‰ä½</th><th>ç®¡ç†</th></tr></thead><tbody></tbody></table>
    </div>
    <div id="p2" class="page"><h3>åº«å­˜ç¸½è¡¨</h3><button class="btn btn-action" onclick="exportToCSV()">ğŸ“Š åŒ¯å‡º</button><table id="fullTable"><thead><tr><th>åç¨±</th><th>å‰©é¤˜</th><th>å€‰ä½</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
    <div id="p3" class="page">
        <h3>ğŸ›’ è³¼ç‰©è»Šå¤–å€Ÿ</h3>
        <div style="background:#f0f7ff; padding:15px; border-radius:10px; margin-bottom:20px; border:1px dashed #3498db;">
            <div class="input-group">
                <select id="cartProductSelect"></select>
                <input type="number" id="cartQty" value="1" min="1" style="width:60px; flex:none;">
                <button class="btn btn-add" onclick="addToCart()">â• åŠ å…¥</button>
            </div>
            <table id="cartTable"><thead><tr><th>å“é …</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
            <input type="text" id="loanUser" placeholder="å€Ÿç”¨äºº" style="margin-top:10px; width:100%">
            <button class="btn btn-action" onclick="checkoutCart()" style="width:100%; margin-top:10px;">ğŸš€ æ‰¹æ¬¡å€Ÿå‡º</button>
        </div>
        <table id="loanTable"><thead><tr><th>å€Ÿç”¨äºº</th><th>ç‰©å“</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>
    <div id="p4" class="page"><h3>ç›¤é»ä¿®æ­£</h3><table id="stocktakeTable"><thead><tr><th>åç¨±</th><th>å¸³é¢æ•¸</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
    <div id="p5" class="page"><h3>ç•°å‹•ç´€éŒ„</h3><table id="historyTable"><thead><tr><th>æ™‚é–“</th><th>å“é …</th><th>è®Šå‹•</th><th>åŸå› </th></tr></thead><tbody></tbody></table></div>
</div>

<script>
    // -------------------------------------------------------------------------
    // âš ï¸ è«‹ç¢ºä¿é€™è£¡å¡«å…¥æ­£ç¢ºçš„ç¶²å€ï¼Œä¸”è©²ç¶²å€åœ¨ç€è¦½å™¨ç›´æ¥æ‰“é–‹èƒ½çœ‹åˆ° {"error":"é‡‘é‘°éŒ¯èª¤"}
    const API_URL = "https://script.google.com/macros/s/AKfycbxhEJ7nGzQSm2VzkO34EWFMxYyWisfbQ24DF67tN7tEWOZHenpEMKACdtG9SmGWO4aaSA/exec"; 
    // -------------------------------------------------------------------------

    let products = [], loans = [], history = [], cart = [];

    async function initSystem() {
        const key = document.getElementById('sysKeyInput').value;
        if (key !== "1225") return alert("é‡‘é‘°éŒ¯èª¤ï¼");

        document.getElementById('msg').innerText = "ğŸ“¡ æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«ï¼Œè«‹ç¨å€™...";
        
        try {
            const res = await fetch(`${API_URL}?key=1225`);
            if (!res.ok) throw new Error("API ç¶²å€å›æ‡‰ç•°å¸¸");
            const data = await res.json();
            
            products = data.products || [];
            loans = data.loans || [];
            history = data.history || [];
            
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('syncLabel').innerText = "âœ… åŒæ­¥æˆåŠŸ";
            renderAll();
        } catch (e) {
            document.getElementById('msg').innerText = "âŒ é€£ç·šå¤±æ•—ï¼è«‹æª¢æŸ¥ API_URL æ˜¯å¦å¡«å¯«æ­£ç¢ºã€‚";
            alert("éŒ¯èª¤ç´°ç¯€ï¼š" + e.message + "\n\n1. è«‹ç¢ºèª API_URL å·²æ­£ç¢ºå¡«å¯«ã€‚\n2. è«‹ç¢ºèª Google Script å·²éƒ¨ç½²ç‚º 'Anyone'ã€‚");
        }
    }

    async function save() {
        document.getElementById('syncLabel').innerText = "â³ å„²å­˜ä¸­...";
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ key: "1225", data: { products, loans, history } })
            });
            document.getElementById('syncLabel').innerText = "âœ… å„²å­˜æˆåŠŸ";
            renderAll();
        } catch (e) { alert("å„²å­˜å¤±æ•—"); }
    }

    function renderAll() {
        // æ¸²æŸ“å»ºæª”
        document.querySelector("#setupTable tbody").innerHTML = products.map(p => `<tr><td>${p.name}</td><td>${p.total}</td><td>${p.loc||''}</td><td><button class="btn btn-action" style="background:#e74c3c" onclick="deleteProduct(${p.id})">åˆªé™¤</button></td></tr>`).join('');
        // æ¸²æŸ“ç¸½è¡¨ (å«ç§»å€‰)
        document.querySelector("#fullTable tbody").innerHTML = products.map(p => `<tr><td>${p.name}</td><td>${p.available} / ${p.total}</td><td>${p.loc||'æœªå®š'}</td><td><button class="btn btn-action" onclick="moveLocation(${p.id})">ç§»å€‰</button></td></tr>`).join('');
        // æ¸²æŸ“æ­¸é‚„
        document.querySelector("#loanTable tbody").innerHTML = loans.map(l => `<tr><td>${l.user}</td><td>${l.pname}</td><td>${l.qty}</td><td><button class="btn btn-action" onclick="returnItem(${l.id})">æ­¸é‚„</button></td></tr>`).join('');
        // æ¸²æŸ“ç´€éŒ„
        document.querySelector("#historyTable tbody").innerHTML = history.map(h => `<tr><td>${h.time}</td><td>${h.name}</td><td>${h.old}â†’${h.new}</td><td>${h.reason}</td></tr>`).join('');
        // æ¸²æŸ“ç›¤é»
        document.querySelector("#stocktakeTable tbody").innerHTML = products.map(p => `<tr><td>${p.name}</td><td>${p.total}</td><td><button class="btn btn-action" onclick="adjust(${p.id})">ç›¤é»</button></td></tr>`).join('');
        // æ›´æ–°è³¼ç‰©è»Šæ¸…å–®
        document.getElementById('cartProductSelect').innerHTML = products.map(p => `<option value="${p.id}">${p.name} (å‰©:${p.available})</option>`).join('');
    }

    function addProduct() {
        const name = document.getElementById('pName').value.trim();
        const qty = parseInt(document.getElementById('pQty').value);
        if(!name || isNaN(qty)) return alert("è«‹å¡«å¯«");
        products.push({ id: Date.now(), name, total: qty, available: qty, loc: document.getElementById('pLoc').value });
        save();
        document.getElementById('pName').value = ''; document.getElementById('pQty').value = '';
    }

    function moveLocation(pid) {
        const p = products.find(i => i.id == pid);
        const nl = prompt("æ–°å€‰ä½ï¼š", p.loc);
        if (nl !== null) { p.loc = nl; save(); }
    }

    function addToCart() {
        const pid = document.getElementById('cartProductSelect').value;
        const qty = parseInt(document.getElementById('cartQty').value);
        const p = products.find(i => i.id == pid);
        if(p && p.available >= qty) {
            cart.push({ pid: p.id, pname: p.name, qty: qty });
            renderCart();
        } else alert("åº«å­˜ä¸è¶³");
    }

    function renderCart() {
        document.querySelector("#cartTable tbody").innerHTML = cart.map((c, i) => `<tr><td>${c.pname}</td><td>${c.qty}</td><td><button class="btn btn-action" style="background:#e74c3c" onclick="cart.splice(${i},1);renderCart();">ç§»é™¤</button></td></tr>`).join('');
    }

    function checkoutCart() {
        const u = document.getElementById('loanUser').value;
        if(!u || cart.length === 0) return alert("è³‡æ–™ä¸å…¨");
        cart.forEach(c => {
            const p = products.find(i => i.id == c.pid);
            p.available -= c.qty;
            loans.push({ id: Date.now()+Math.random(), pid: p.id, pname: p.name, user: u, qty: c.qty });
        });
        cart = []; document.getElementById('loanUser').value = ""; renderCart(); save();
    }

    function returnItem(lid) {
        const l = loans.find(i => i.id == lid);
        const p = products.find(i => i.id == l.pid);
        if(p) p.available += l.qty;
        loans = loans.filter(i => i.id !== lid);
        save();
    }

    function deleteProduct(id) {
        if(prompt("è«‹è¼¸å…¥ 1225 ç¢ºèªåˆªé™¤") === "1225") {
            products = products.filter(i => i.id !== id);
            save();
        }
    }

    function adjust(id) {
        const v = prompt("å¯¦ç›¤æ•¸é‡ï¼š");
        if(v !== null) {
            const p = products.find(i => i.id == id);
            p.total = parseInt(v); p.available = parseInt(v);
            save();
        }
    }

    function exportToCSV() {
        let csv = "\ufeffå“å,ç¸½æ•¸,å¯ç”¨,å€‰ä½\n" + products.map(p => `${p.name},${p.total},${p.available},${p.loc||''}`).join('\n');
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        link.download = "åº«å­˜ç›¤é»è¡¨.csv"; link.click();
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-' + id).classList.add('active');
    }
</script>
</body>
</html>
